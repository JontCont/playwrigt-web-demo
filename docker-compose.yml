version: '3.8'

services:
  # Angular Frontend Application
  frontend:
    build:
      context: .
      dockerfile: Dockerfile.frontend
    ports:
      - "4200:80"
    environment:
      - API_URL=http://localhost:5000
    depends_on:
      - gateway

  # Angular Admin Application
  admin:
    build:
      context: .
      dockerfile: Dockerfile.admin
    ports:
      - "4201:80"
    environment:
      - API_URL=http://localhost:5000
    depends_on:
      - gateway

  # API Gateway (統一入口)
  gateway:
    build:
      context: ./backend
      dockerfile: gateway/Dockerfile
    ports:
      - "5000:5000"
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_URLS=http://+:5000
      - FrontendApiUrl=http://frontend-api:5001
      - AdminApiUrl=http://admin-api:5002
    depends_on:
      - frontend-api
      - admin-api

  # Frontend API Service
  frontend-api:
    build:
      context: ./backend
      dockerfile: frontend-api/Dockerfile
    ports:
      - "5001:5001"
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_URLS=http://+:5001
      - ConnectionStrings__DefaultConnection=Host=db;Database=playwrightdemo;Username=postgres;Password=postgres
    depends_on:
      - db

  # Admin API Service
  admin-api:
    build:
      context: ./backend
      dockerfile: admin-api/Dockerfile
    ports:
      - "5002:5002"
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_URLS=http://+:5002
      - ConnectionStrings__DefaultConnection=Host=db;Database=playwrightdemo;Username=postgres;Password=postgres
    depends_on:
      - db

  # PostgreSQL Database
  db:
    image: postgres:16-alpine
    ports:
      - "5432:5432"
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
      - POSTGRES_DB=playwrightdemo
    volumes:
      - postgres_data:/var/lib/postgresql/data

  # Redis - Dapr Pub/Sub Broker
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"

  # Seq - Centralized Logging
  seq:
    image: datalust/seq:latest
    ports:
      - "5341:80"
    environment:
      - ACCEPT_EULA=Y

  # order-api (Publisher)
  order-api:
    build:
      context: ./backend
      dockerfile: order-api/Dockerfile
    ports:
      - "5003:5003"
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:5003
      - SEQ_URL=http://seq:80
    depends_on:
      - redis
      - seq

  # order-api Dapr Sidecar
  order-api-dapr:
    image: "daprio/daprd:latest"
    command:
      [
        "./daprd",
        "--app-id", "order-api",
        "--app-port", "5003",
        "--dapr-http-port", "3500",
        "--dapr-grpc-port", "50001",
        "--resources-path", "/components"
      ]
    volumes:
      - ./backend/dapr/components:/components
    depends_on:
      - order-api
      - redis
    network_mode: "service:order-api"

  # notification-api (Subscriber)
  notification-api:
    build:
      context: ./backend
      dockerfile: notification-api/Dockerfile
    ports:
      - "5004:5004"
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:5004
      - SEQ_URL=http://seq:80
    depends_on:
      - redis
      - seq

  # notification-api Dapr Sidecar
  notification-api-dapr:
    image: "daprio/daprd:latest"
    command:
      [
        "./daprd",
        "--app-id", "notification-api",
        "--app-port", "5004",
        "--dapr-http-port", "3501",
        "--dapr-grpc-port", "50002",
        "--resources-path", "/components"
      ]
    volumes:
      - ./backend/dapr/components:/components
    depends_on:
      - notification-api
      - redis
    network_mode: "service:notification-api"

volumes:
  postgres_data:
